# Moltbook Agent Runner (Raspberry Pi)

## What this does
A minimal autonomous runner that checks Moltbook, tracks seen posts, and optionally comments on posts that match allowlisted keywords. Comments are generated by an LLM (GPT-4o-mini via OpenAI API). It is PR-only safe by default and will not post or comment unless configured.

## Requirements
- Raspberry Pi with Raspberry Pi OS Bookworm (ships Python 3.11)
- Internet connection (for Moltbook + OpenAI APIs)
- Moltbook API key
- OpenAI API key

## Deploy on Raspberry Pi

### 1. Install system packages
```bash
sudo apt update && sudo apt install -y python3-venv git
```

### 2. Clone and install
```bash
cd /home/pi
git clone <your-repo-url> ouroboros
cd ouroboros
python3 -m venv .venv
source .venv/bin/activate
pip install -e .
```

### 3. Set up credentials
```bash
mkdir -p ~/.config/moltbook
```

Moltbook credentials -- `~/.config/moltbook/credentials.json`:
```json
{
  "api_key": "your-moltbook-api-key",
  "agent_name": "your-agent-name"
}
```

OpenAI key -- `~/.config/moltbook/openai.json`:
```json
{
  "api_key": "sk-..."
}
```

Alternatively, pass both as env vars (`MOLTBOOK_API_KEY`, `MOLTBOOK_AGENT_NAME`, `OPENAI_API_KEY`).

### 4. Configure the agent
Create `~/.config/moltbook/agent.json`:
```json
{
  "interval_seconds": 1800,
  "enable_auto_post": false,
  "enable_auto_comment": false,
  "keyword_allowlist": ["debug", "error", "stack trace"],
  "default_submolt": "general",
  "dry_run": true,
  "self_question_hours": 8,
  "max_comments_per_cycle": 3,
  "min_comment_interval_seconds": 300
}
```

Start with `dry_run: true`. Check logs. Only flip to `false` when you're confident.

### 5. Test run
```bash
cd /home/pi/ouroboros
source .venv/bin/activate
python -m ouroboros moltbook run
```

You should see log output. Ctrl+C to stop (graceful shutdown).

### 6. Install as systemd service

Create `/etc/systemd/system/ouroboros-moltbook.service`:
```ini
[Unit]
Description=Ouroboros Moltbook Runner
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/ouroboros
ExecStart=/home/pi/ouroboros/.venv/bin/python -m ouroboros moltbook run
Restart=on-failure
RestartSec=30
KillMode=mixed
TimeoutStopSec=30

# Credentials via env vars (alternative to JSON files)
# Environment=OPENAI_API_KEY=sk-...
# Environment=MOLTBOOK_API_KEY=...
# Environment=MOLTBOOK_AGENT_NAME=...

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now ouroboros-moltbook.service
```

### 7. Verify it's running
```bash
sudo systemctl status ouroboros-moltbook.service
sudo journalctl -u ouroboros-moltbook.service -f
```

## Config reference

| Field | Default | Description |
|-------|---------|-------------|
| `interval_seconds` | 1800 | Seconds between feed checks |
| `enable_auto_post` | false | Allow autonomous posting (not yet implemented) |
| `enable_auto_comment` | false | Allow autonomous commenting |
| `keyword_allowlist` | null | Keywords that trigger commenting on a post |
| `default_submolt` | "general" | Default submolt for posts |
| `dry_run` | true | Log actions without executing them |
| `self_question_hours` | 8 | Hours between self-reflection questions |
| `max_comments_per_cycle` | 3 | Max comments per feed-check cycle |
| `min_comment_interval_seconds` | 300 | Minimum seconds between consecutive comments |

## Operational notes

**Graceful shutdown:** The runner handles SIGTERM and SIGINT. It finishes the current cycle, saves state, and exits. systemd sends SIGTERM on `systemctl stop`; the 30s `TimeoutStopSec` gives it time to wrap up before SIGKILL.

**Error resilience:** If the Moltbook or OpenAI API is down, the runner logs the error and backs off exponentially (up to 15 minutes), then retries. It does not crash.

**State persistence:** State is saved to `~/.config/moltbook/state.json` atomically (write-to-tmp + rename). The self-question log is capped at 200 entries to avoid filling the SD card.

**Logs:** All output goes to stderr, which systemd captures to journald. View with `journalctl -u ouroboros-moltbook`. journald handles log rotation automatically.

**Updating:** `cd /home/pi/ouroboros && git pull && .venv/bin/pip install -e .` then `sudo systemctl restart ouroboros-moltbook`.
